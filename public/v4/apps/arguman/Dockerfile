# syntax=docker/dockerfile:1.3-labs
FROM python:2.7-slim
WORKDIR /app

RUN apt-get update && apt-get install -y git python-dev \
  build-essential \
  libpq-dev \
  && rm -rf /var/lib/apt/lists/*

RUN \
  git clone https://github.com/arguman/arguman.org.git . && \
  ls -al .
RUN pip install -r requirements.txt
RUN python -m textblob.download_corpora
# - >-
#  ARG full_Script="
#COPY <<EOF web/main/settings_local.py
# see https://github.com/arguman/arguman.org/blob/master/web/main/settings_local.py.ex
RUN echo "EOL\
  DEFAULT_FROM_EMAIL = 'info@arguman.org' EOL\
  POSTMARK_TOKEN = 'xyz' EOL\
  POSTMARK_API_URL = 'https://api.postmarkapp.com/email' EOL\
  # EOL\
  # EOL\
  DATABASES = { EOL\
  'default': { EOL\
  'ENGINE': 'django.db.backends.postgresql_psycopg2', EOL\
  'NAME': 'postgres', EOL\
  'USER': 'postgres', EOL\
  'HOST': 'db', EOL\
  'PORT': 5432, EOL\
  } EOL\
  } EOL\
  ALLOWED_HOSTS = ['*'] EOL\
  DEBUG = True EOL\
  # EOL\
  SERVER_EMAIL = 'info@arguman.org' EOL\
  BASE_DOMAIN = 'localhost:8000' #your docker machine ip if running on virtual server EOL\
  MONGODB_HOST = 'srv-captain--arg-44-mongodb' #your docker machine ip if running on virtual server EOL\
  # CACHES = { EOL\
  #     "default": { EOL\
  #         "BACKEND": "redis_cache.cache.RedisCache", EOL\
  #         "LOCATION": "127.0.0.1:6379:1" EOL\
  #     } EOL\
  # } EOL\
  " |  sed "s/EOL  /\n/g" >web/main/settings_local.py # The space after EOL is generated by yaml when process this multiline string
#RUN cat /etc/os-release && apt-get update && apt-get install vim -y && xxd web/main/settings_local.py
RUN apt-get update && apt-get install netcat -y && nc -zv srv-captain--arg-44-mongodb 27017


#RUN echo $full_Script >> settings_local.py
RUN printf "settings_local.py is v1\n" && cat web/main/settings_local.py && ls -al web/main/settings_local.py
RUN python web/manage.py migrate
EXPOSE 8000
CMD ["python", "web/manage.py","runserver","0.0.0.0:8000"]
