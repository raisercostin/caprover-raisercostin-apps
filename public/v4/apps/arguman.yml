captainVersion: 4

services:
  # $$cap_appname-redis:
  #   image: redis:latest
  #   restart: always

  # $$cap_appname-mongo:
  #   image: mongo:3.2.3
  #   restart: always
  #   ports:
  #     - '27017:27017'

  # $$cap_appname-db:
  #   image: postgres:latest
  #   restart: always

  $$cap_appname:
    caproverExtra:
      # see https://github.com/caprover/one-click-apps/blob/master/public/v4/apps/pocketbase.yml
      dockerfileLines:
        - "# syntax=docker/dockerfile:1.3-labs"
        - FROM python:2.7-slim
        - WORKDIR /app
        - RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
        - |
          RUN \
          git config --global url."https://api:$$cap_git_token@github.com/".insteadOf "https://github.com/" && \
          git config --global url."https://ssh:$$cap_git_token@github.com/".insteadOf "ssh://git@github.com/" && \
          git config --global url."https://git:$$cap_git_token@github.com/".insteadOf "git@github.com:" && \
          git clone $$cap_git_project . && \
          ls -al .
        - RUN pip install -r requirements.txt
        - RUN python -m textblob.download_corpora
        # - >-
        #     ARG full_Script="\\n
        #     echo see https://github.com/arguman/arguman.org/blob/master/web/main/settings_local.py.ex\\n
        #     DEFAULT_FROM_EMAIL = 'info@arguman.org'\\n
        #     POSTMARK_TOKEN = "xyz"\\n
        #     POSTMARK_API_URL = "https://api.postmarkapp.com/email"\\n
        #     echo\\n
        #     echo\\n
        #     DATABASES = {\\n
        #         'default': {\\n
        #             'ENGINE': 'django.db.backends.postgresql_psycopg2',\\n
        #             'NAME': 'postgres',\\n
        #             'USER': 'postgres',\\n
        #             'HOST': 'db',\\n
        #             'PORT': 5432,\\n
        #         }\\n
        #     }\\n
        #     ALLOWED_HOSTS = ['*']\\n
        #     DEBUG = True\\n
        #     echo\\n
        #     SERVER_EMAIL = 'info@arguman.org'\\n
        #     BASE_DOMAIN = 'localhost:8000' #your docker machine ip if running on virtual server\\n
        #     MONGODB_HOST = 'localhost' #your docker machine ip if running on virtual server\\n
        #     echo CACHES = {\\n
        #     echo     "default": {\\n
        #     echo         "BACKEND": "redis_cache.cache.RedisCache",\\n
        #     echo         "LOCATION": "127.0.0.1:6379:1"\\n
        #     echo     }\\n
        #     echo }\\n
        #     "
        # - RUN echo $full_Script >> settings_local.py
        # - RUN printf "settings_local.py is\n" && cat settings_local.py
        - RUN python web/manage.py migrate
        - EXPOSE 8000
        - CMD ["python", "web/manage.py","runserver","0.0.0.0:8000"]
      containerHttpPort: '8000'
    volumes:
      - '$$cap_appname-data:/code'
    # depends_on:
    #   - $$cap_appname-db
    #   - $$cap_appname-redis
    #   - $$cap_appname-mongo
    # '$$cap_appname':
    #   image: privatebin/nginx-fpm-alpine:$$cap_version
    #   environment:
    #     TZ: '$$cap_tz'
    #     PHP_TZ: '$$cap_tz'
    #   volumes:
    #     - '$$cap_appname-data:/srv/data'
    #     - '$$cap_appname-cfg:/srv/cfg'
    #   caproverExtra:
    #     containerHttpPort: '8080'
caproverOneClickApp:
  variables:
  - id: $$cap_git_project
    label: Git Project
    defaultValue: 'https://github.com/arguman/arguman.org.git'
    description: "For private repos add the user/token here (ex:https://username:token@github.com/) or for github.com you can configure username/token."
    validRegex: /.{1,}/
  - id: $$cap_git_username
    label: Git Username
    defaultValue: ''
  - id: $$cap_git_access_token
    label: Git Access Token For Private Repos
    defaultValue: ''
    description: Get your github token from https://github.com/settings/tokens/new
  instructions:
    start: >-
      1. Fill in the database password.
      2. Deploy the app.

      More details on https://github.com/arguman/arguman.org

    end: >-
      Aaaand you're done! ðŸ˜„
      Your service is available at http://$$cap_appname.$$cap_root_domain
  displayName: Arguman
  isOfficial: true
  description: Arguman is a platform for creating and sharing structured arguments.
  documentation: >-
    Originaly at https://arguman.org but the english database got lost.


# {
#   "captainVersion": "4",
#   "version": "3.3"
#   "services": {
#     "$$cap_appname": {
#           "image": "adminer:$$cap_adminer_version",
#           "containerHttpPort": "8080",
#           "environment": {
#               "ADMINER_DESIGN": "$$cap_adminer_design"
#           }
#     }
#   }
# }
